---
title: "Stormy Lakes Model Outputs"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(tidyverse.quiet = TRUE)
```

```{r echo=FALSE, message=FALSE}
tar_load(winter_rf)
tar_load(summer_rf)
tar_load(winter_tree)
tar_load(summer_tree)
tar_load(winter_lm)
tar_load(summer_lm)
tar_load(lm_stats_out)
tar_load(summary_table)
```

Generated on `r Sys.Date()`

### Targets workflow diagram:
```{r fig.height=8, fig.width=8}
tar_visnetwork()
```

<br>

---

### Winter season model results:

#### **Predictor correlations**

<details>
<summary>Click for details</summary>
![](figures/winter_model_correlations.png)
</details>

#### **RF**

<details>
<summary>Click for details</summary>
```{r}
winter_rf$winter_model

winter_rf$winter_model["finalModel"]

```
![](figures/winter_summary_plot.png)
</details>

<br>

#### **Regression tree**

<details>
<summary>Click for details</summary>
```{r}
summary(winter_tree)
rpart.plot(winter_tree)
print(winter_tree)
```

R-squared:
[Source](https://stats.stackexchange.com/questions/5792/r-square-from-rpart-model)
```{r}
# Save output of cp table for the tree
split_data_winter <- printcp(winter_tree)
# Make 1 - rel.error and 1 - xerror columns
rsq_val_winter <- 1 - split_data_winter[, c(3, 4)]  
# Retrieve vals from final row of table
rsq_val_winter[nrow(rsq_val_winter), ]
```
</details>

<br>

#### **Linear model**

<details>
<summary>Click for details</summary>
```{r}
car::Anova(winter_lm$model, type=3)
summary(winter_lm$model)
winterStat <- broom::tidy(winter_lm$model)

modelOut <- effect("TP_log10:underice_mean_precip", winter_lm$model,
                   xlevels = list(TP_log10 = seq(0, 2.5, by = 0.2),
                                  underice_mean_precip = c(30, 50, 80))) %>%
  data.frame()

plot_a <- ggplot(modelOut, aes(x = TP_log10, y = fit,
                               color = as.factor(underice_mean_precip))) +
  geom_line(lwd = 2)  +
  theme_classic() +
  xlab("Total Phosphorus (log)") +
  ylab("Chlorophyll Concentrations (log)") + 
  scale_color_manual("Mean Precip \n at Sample (mm/mo)",
                     values = c( "#56B4E9","#999999", "#E69F00")) +
  geom_point(data = winter_lm$winterNA, aes(x = TP_log10, y = avechla_log10),
             color = "black") +
  theme(text = element_text(size = 20),
        legend.position = c(0.3, 0.75),
        legend.title = element_text(size = 17),
        legend.text = element_text(size = 16),
        legend.background = element_rect(fill = "transparent"))

ggsave(filename = "figures/winter_lm_fig.png", plot = plot_a, device = "png",
       height = 6, width = 6, units = "in")
```

```{r}
plot_a
```
</details>

<br>

---

### Summer season model results:

#### **Predictor correlations**

<details>
<summary>Click for details</summary>
![](figures/summer_model_correlations.png)
</details>

#### **RF**

<details>
<summary>Click for details</summary>
```{r}
summer_rf$summer_model

summer_rf$summer_model["finalModel"]
```

![](figures/summer_summary_plot.png)
</details>

<br>

#### **Regression tree**

<details>
<summary>Click for details</summary>
```{r}
summary(summer_tree)
rpart.plot(summer_tree)
print(summer_tree)
rsq.rpart(summer_tree)

```

R-squared:
[Source](https://stats.stackexchange.com/questions/5792/r-square-from-rpart-model)
```{r}
# Save output of cp table for the tree
split_data_summer <- printcp(summer_tree)
# Make 1 - rel.error and 1 - xerror columns
rsq_val_summer <- 1 - split_data_summer[, c(3, 4)]  
# Retrieve vals from final row of table
rsq_val_summer[nrow(rsq_val_summer), ]
```
</details>

<br>

#### **Linear model**
<details>
<summary>Click for details</summary>
```{r}
car::Anova(summer_lm$model, type = 3)

summerStat <- broom::tidy(summer_lm$model)

modelOut1 <- effect("TP_log10:watertemp", summer_lm$model, 
                    xlevels = list(TP_log10 = seq(0, 2.5, by = 0.2),
                                   watertemp = c(14, 17, 20))) %>%
  data.frame()

off1 <- ggplot(modelOut1, aes(x = TP_log10, y = fit, color = as.factor(watertemp))) +
  geom_line(lwd = 2)  +
  theme_classic() +
  xlab("Total Phosphorus (log)") +
  ylab("Chlorophyll Concentrations (log)") + 
  scale_color_manual("Water Temp (\u00B0C)", 
                     values = c("#56B4E9", "#999999", "#E69F00")) +
  geom_point(data = summer_lm$summerNA, aes(x = TP_log10, y = avechla_log10),
             color = "black") + 
  theme(text = element_text(size = 20),
        legend.position = c(0.25, 0.75),
        legend.title = element_text(size = 17),
        legend.text = element_text(size = 16),
        legend.background = element_rect(fill = "transparent"))

ggsave(filename = "figures/summer_water_lm_fig.png", plot = off1, device = "png",
       height = 6, width = 6, units = "in")

modelOut2 <- effect("TN_log10:scale(strat_mean_slp)", summer_lm$model,
                    xlevels = list(TN_log10 = seq(1, 3.6, 0.2),
                                   strat_mean_slp = c(95000, 98000, 101000))) %>%
  data.frame()

off2 <- ggplot(modelOut2, aes(x = TN_log10, y = fit,
                              color = as.factor(strat_mean_slp))) +
  geom_line(lwd = 2)  +
  theme_classic() +
  xlab("Total Nitrogen (log)") +
  ylab("Chlorophyll Concentrations (log)") + 
  scale_color_manual("Mean SLP (Pa)",
                     values = c("#56B4E9", "#999999", "#E69F00")) +
  geom_point(data = summer_lm$summerNA, aes(x = TN_log10, y = avechla_log10),
             color = "black") +
  theme(text = element_text(size = 20),
        legend.position = c(0.25, 0.75),
        legend.title = element_text(size = 17),
        legend.text = element_text(size = 16),
        legend.background = element_rect(fill = "transparent"))

ggsave(filename = "figures/summer_slp_lm_fig.png", plot = off2, device = "png",
       height = 6, width = 6, units = "in")
```

<br>

```{r}
off1

off2
```
</details>

<br>

---

### Linear models summary table

```{r echo=FALSE}
lm_stats_out$lm_stats_table %>%
  kable() %>%
  kable_paper()
```

<br>


```{r echo=FALSE}
combined_lms <- ggarrange(plot_a, off1 + ylab(NULL), off2 + ylab(NULL), nrow = 1)
ggsave(filename = "figures/combined_lm_figs.png", plot = combined_lms,
       device = "png", width = 15, height = 5, units = "in")
```


---

### General summary table
<details>
<summary>Click for table</summary>
```{r echo=FALSE}
summary_table %>%
  kable() %>%
  kable_paper()
```
</details>

---

### Warnings:
```{r echo = FALSE}
tar_meta(fields = warnings, complete_only = TRUE) %>%
  kable() %>%
  kable_paper()
```